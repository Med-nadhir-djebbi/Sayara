@{
    ViewData["Title"] = "Create Listing";
}

<div class="container animate-fade-in" style="max-width: 1000px; padding: 60px 20px; min-height: calc(100vh - 180px); display: flex; flex-direction: column; justify-content: center;">
    
    <div style="text-align: center; margin-bottom: 50px;">
        <div class="hero-badge mb-3">New Listing</div>
        <h1 id="pageTitle" class="section-title mb-2">Publish Your <span class="text-primary">Masterpiece</span></h1>
        <p class="text-muted">Fill in the specifications to present your vehicle to our exclusive network.</p>
        
        <!-- Listing Type Toggle -->
        <div class="toggle-container mt-4">
            <button type="button" id="saleToggle" class="type-btn active" onclick="setType('sale')">For Sale</button>
            <button type="button" id="rentToggle" class="type-btn" onclick="setType('rent')">For Rent</button>
        </div>
    </div>

    <form id="createForm" enctype="multipart/form-data">
        <input type="hidden" name="ListingType" id="listingType" value="sale">
        <div class="stack-layout">
            
            <!-- Section 1: Identity -->
            <div class="premium-card p-4 mb-4">
                <div class="d-flex align-items-center mb-4">
                    <div class="step-indicator">01</div>
                    <h5 class="mb-0 ml-3 font-weight-bold">Vehicle Identity</h5>
                </div>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label class="form-label">Brand</label>
                        <select name="BrandId" class="form-control-premium" required>
                            <option value="" disabled selected>Select Brand</option>
                            <option value="1">Audi</option>
                            <option value="2">BMW</option>
                            <option value="3">Mercedes</option>
                            <option value="4">Porsche</option>
                            <option value="5">Volkswagen</option>
                            <option value="6">Toyota</option>
                            <option value="7">Ford</option>
                            <option value="8">Renault</option>
                            <option value="9">Peugeot</option>
                            <option value="10">Citroen</option>
                            <option value="11">Fiat</option>
                            <option value="12">Hyundai</option>
                            <option value="13">Kia</option>
                            <option value="14">Nissan</option>
                            <option value="15">Honda</option>
                            <option value="16">Mazda</option>
                            <option value="17">Mitsubishi</option>
                            <option value="18">Suzuki</option>
                            <option value="19">Tesla</option>
                            <option value="20">Volvo</option>
                            <option value="21">Land Rover</option>
                            <option value="22">Jaguar</option>
                            <option value="23">Ferrari</option>
                            <option value="24">Lamborghini</option>
                            <option value="25">Maserati</option>
                            <option value="26">Aston Martin</option>
                            <option value="27">Bentley</option>
                            <option value="28">Rolls-Royce</option>
                            <option value="29">Alfa Romeo</option>
                            <option value="30">Lexus</option>
                            <option value="31">Jeep</option>
                            <option value="32">Chevrolet</option>
                            <option value="33">Dodge</option>
                            <option value="34">Chrysler</option>
                            <option value="35">Cadillac</option>
                            <option value="36">GMC</option>
                            <option value="37">RAM</option>
                            <option value="38">Subaru</option>
                            <option value="39">Isuzu</option>
                            <option value="40">Infiniti</option>
                            <option value="41">Acura</option>
                            <option value="42">Genesis</option>
                            <option value="43">Cupra</option>
                            <option value="44">Seat</option>
                            <option value="45">Skoda</option>
                            <option value="46">Mini</option>
                            <option value="47">Smart</option>
                            <option value="48">Dacia</option>
                            <option value="49">Lada</option>
                            <option value="50">MG</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Model</label>
                        <input type="text" name="Model" class="form-control-premium" placeholder="e.g. 911 GT3" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Year of Manufacture</label>
                        <input type="number" name="Year" class="form-control-premium" placeholder="2024" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Mileage (KM)</label>
                        <input type="number" name="Mileage" class="form-control-premium" placeholder="0" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Exterior Color</label>
                        <input type="text" name="Color" class="form-control-premium" placeholder="e.g. Shark Blue" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Transmission</label>
                        <select name="TransmissionType" class="form-control-premium" required>
                            <option value="0">Manual</option>
                            <option value="1" selected>Automatic</option>
                            <option value="2">CVT</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Section 2: Performance -->
            <div class="premium-card p-4 mb-4">
                <div class="d-flex align-items-center mb-4">
                    <div class="step-indicator">02</div>
                    <h5 class="mb-0 ml-3 font-weight-bold">Performance Specs</h5>
                </div>
                <div class="row g-4">
                    <div class="col-md-4">
                        <label class="form-label">Engine Architecture</label>
                        <select name="EngineType" class="form-control-premium" required>
                            <option value="0">Petrol</option>
                            <option value="1">Diesel</option>
                            <option value="2">Electric</option>
                            <option value="3">Hybrid</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fiscal Power (HP)</label>
                        <input type="number" name="FiscalPower" class="form-control-premium" placeholder="e.g. 15" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Displacement (Liters)</label>
                        <input type="number" step="0.1" name="CylinderCapacity" class="form-control-premium" placeholder="e.g. 4.0" required>
                    </div>
                </div>
            </div>

            <!-- Section 3: Commercial -->
            <div class="premium-card p-4 mb-4">
                <div class="d-flex align-items-center mb-4">
                    <div class="step-indicator">03</div>
                    <h5 class="mb-0 ml-3 font-weight-bold">Valuation & Media</h5>
                </div>
                
                <div id="salePricing">
                    <label class="form-label">Acquisition Price ($)</label>
                    <div class="input-group-premium">
                        <span class="currency">$</span>
                        <input type="number" name="Price" id="salePriceInput" class="form-input-clean" placeholder="0.00">
                    </div>
                </div>

                <div id="rentPricing" style="display: none;">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <label class="form-label">Daily Cycle ($)</label>
                            <input type="number" name="DailyRate" class="form-control-premium" placeholder="0.00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Weekly Cycle ($)</label>
                            <input type="number" name="WeeklyRate" class="form-control-premium" placeholder="0.00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Monthly Cycle ($)</label>
                            <input type="number" name="MonthlyRate" class="form-control-premium" placeholder="0.00">
                        </div>
                    </div>
                </div>

                <div class="mt-5">
                    <label class="form-label d-block mb-3">Vehicle Portrayal</label>
                    <div class="dropzone-premium" onclick="document.getElementById('photoInput').click()">
                        <div class="text-center">
                            <div class="upload-icon-circle mb-3"><i class="fas fa-camera"></i></div>
                            <p class="font-weight-bold mb-1">Upload High-Res Imagery</p>
                            <p class="text-muted small">Select up to 10 images of the exterior and interior.</p>
                        </div>
                        <input type="file" id="photoInput" name="photos" multiple accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                    </div>
                    <div id="photoPreviewContainer" class="preview-grid-modern mt-4"></div>
                </div>
            </div>

            <!-- Section 4: Narrative -->
            <div class="premium-card p-4 mb-5">
                <div class="d-flex align-items-center mb-4">
                    <div class="step-indicator">04</div>
                    <h5 class="mb-0 ml-3 font-weight-bold">The Narrative</h5>
                </div>
                <textarea name="Description" class="form-control-premium" rows="6" placeholder="Describe the vehicle's provenance, maintenance history, and unique options..."></textarea>
            </div>

            <div class="form-footer">
                <button type="submit" id="submitBtn" class="btn btn-primary w-100 py-4 shadow-premium">
                    <i class="fas fa-check-circle mr-2"></i> Confirm and Publish
                </button>
            </div>
        </div>
    </form>
</div>

<style>
    .stack-layout { display: flex; flex-direction: column; gap: 30px; }
    .toggle-container { display: inline-flex; background: #f1f5f9; padding: 6px; border-radius: 14px; border: 1px solid #e2e8f0; }
    .type-btn { padding: 12px 30px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; background: transparent; color: #64748b; font-size: 0.95rem; }
    .type-btn.active { background: white; color: var(--primary-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    
    .step-indicator { width: 36px; height: 36px; background: var(--primary-blue); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 800; }
    .form-control-premium { width: 100%; padding: 14px 20px; border-radius: 12px; border: 1px solid #e2e8f0; background: #fff; transition: 0.3s; font-size: 1rem; }
    .form-control-premium:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 4px rgba(0, 80, 158, 0.08); outline: none; }
    
    .input-group-premium { display: flex; align-items: center; width: 100%; border: 1px solid #e2e8f0; border-radius: 12px; background: #fff; overflow: hidden; }
    .input-group-premium .currency { padding: 0 20px; background: #f8fafc; color: #64748b; font-weight: 700; border-right: 1px solid #e2e8f0; height: 55px; line-height: 55px; }
    .input-group-premium input { border: none; padding: 14px 20px; width: 100%; font-size: 1.2rem; font-weight: 700; }
    
    .dropzone-premium { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 20px; padding: 60px 40px; cursor: pointer; transition: 0.3s; }
    .dropzone-premium:hover { border-color: var(--primary-blue); background: #f1f5f9; }
    .upload-icon-circle { width: 60px; height: 60px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #94a3b8; margin: 0 auto; box-shadow: var(--shadow-sm); }
    
    .preview-grid-modern { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
    .preview-item-luxury { position: relative; border-radius: 14px; overflow: hidden; aspect-ratio: 1; border: 2px solid #fff; box-shadow: var(--shadow-sm); }
    .preview-item-luxury img { width: 100%; height: 100%; object-fit: cover; }
    .remove-trigger { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(4px); font-size: 0.8rem; }
</style>

<script>
    let selectedType = 'sale';
    let uploadedFiles = [];

    function setType(type) {
        selectedType = type;
        document.getElementById('listingType').value = type;
        document.getElementById('saleToggle').classList.toggle('active', type === 'sale');
        document.getElementById('rentToggle').classList.toggle('active', type === 'rent');
        document.getElementById('salePricing').style.display = type === 'sale' ? 'block' : 'none';
        document.getElementById('rentPricing').style.display = type === 'rent' ? 'block' : 'none';
        document.getElementById('salePriceInput').required = type === 'sale';
    }

    function handleFileSelect(event) {
        const files = Array.from(event.target.files);
        const container = document.getElementById('photoPreviewContainer');
        
        files.forEach(file => {
            uploadedFiles.push(file);
            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                div.className = 'preview-item-luxury animate-fade-in';
                div.innerHTML = `
                    <img src="${e.target.result}">
                    <div class="remove-trigger" onclick="removePhoto(this, '${file.name}')">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                container.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }

    function removePhoto(element, fileName) {
        element.parentElement.remove();
        uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
    }

    document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerHTML;
        
        // Enforce Login
        if (!localStorage.getItem('token')) {
            window.location.href = '/login?returnUrl=' + encodeURIComponent(window.location.href);
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Registering Pedigree...';

        const formData = new FormData(e.target);
        formData.delete('photos'); 
        uploadedFiles.forEach(file => formData.append('photos', file));

        try {
            const endpoint = selectedType === 'sale' ? '/api/Listings/sale' : '/api/Listings/rent';
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                btn.style.background = '#059669';
                btn.innerHTML = '<i class="fas fa-check-double mr-2"></i> Published to Marketplace';
                setTimeout(() => window.location.href = `/${selectedType}`, 1500);
            } else {
                let errorMsg = result.message || 'Synchronization failed';
                if (result.errors) errorMsg = Object.values(result.errors).flat().join('\n');
                alert(errorMsg);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (err) {
            console.error(err);
            alert('A network error interrupted the transmission.');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('type') === 'rent') setType('rent');
    });
</script>
