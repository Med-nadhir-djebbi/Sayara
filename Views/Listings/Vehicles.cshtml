@{
    ViewData["Title"] = "All Vehicles";
}

<div class="container" style="padding: 40px 20px;">
<div class="row-layout">
    <!-- Sidebar Filter -->
    <aside class="sidebar-filter">
        <div class="filter-header">
            <h3>Filter Vehicles</h3>
            <button id="closeFilterBtn" class="d-md-none">&times;</button>
        </div>
        
        <div class="filter-group">
            <label>Search</label>
            <input type="text" id="filterSearch" class="form-control" placeholder="Model, keywords...">
        </div>

        <div class="filter-group">
            <label>Looking for</label>
            <select id="filterType" class="form-control">
                <option value="all">All Vehicles</option>
                <option value="sale">Cars for Sale</option>
                <option value="rent">Cars for Rent</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Transmission</label>
            <select id="filterTransmission" class="form-control">
                <option value="all">Any Transmission</option>
                <option value="Automatic">Automatic</option>
                <option value="Manual">Manual</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Brand</label>
            <select id="filterBrand" class="form-control">
                <option value="all">All Brands</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Engine Type</label>
            <select id="filterEngine" class="form-control">
                <option value="all">All Engines</option>
                <option value="Gasoline">Gasoline</option>
                <option value="Diesel">Diesel</option>
                <option value="Electric">Electric</option>
                <option value="Hybrid">Hybrid</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Year Range</label>
            <div class="range-inputs">
                <input type="number" id="minYear" placeholder="Min" class="form-control">
                <input type="number" id="maxYear" placeholder="Max" class="form-control">
            </div>
        </div>

        <div class="filter-group">
            <label>Mileage (km)</label>
            <div class="range-inputs">
                <input type="number" id="minMileage" placeholder="Min" class="form-control">
                <input type="number" id="maxMileage" placeholder="Max" class="form-control">
            </div>
        </div>

        <button id="applyFilters" class="btn btn-primary w-100">Apply Filters</button>
    </aside>

    <!-- Main Content -->
    <main class="content-area">
        <div class="content-header">
            <div>
                 <h1 style="color: var(--primary-blue); font-weight: 800; margin-bottom: 5px;">Find Your Perfect Vehicle</h1>
                 <p style="color: var(--text-muted); margin-bottom: 0;">Browse our extensive collection.</p>
            </div>
            <button id="showFilterBtn" class="btn btn-outline d-md-none">Filters</button>
             <a href="/create?type=sale" class="btn btn-success" id="createBtn" style="display:none;">Sell / Rent Your Car</a>
        </div>

        <div style="margin-bottom: 20px; color: var(--text-muted); font-weight: 500;">
            Showing <span id="resultCount">0</span> vehicles
        </div>

        <div class="listings-grid" id="vehiclesGrid">
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">Loading vehicles...</div>
        </div>
    </main>
</div>

<style>
    .row-layout {
        display: flex;
        gap: 30px;
        position: relative;
    }

    .sidebar-filter {
        width: 300px;
        flex-shrink: 0;
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
        height: fit-content;
        position: sticky;
        top: 90px;
    }

    .content-area {
        flex: 1;
    }

    .filter-group {
        margin-bottom: 20px;
    }

    .filter-group label {
        display: block;
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 8px;
        color: var(--text-dark);
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #fff;
        font-family: inherit;
    }

    .range-inputs {
        display: flex;
        gap: 10px;
    }

    .w-100 { width: 100%; }

    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .d-md-none { display: none; }

    @@media (max-width: 900px) {
        .row-layout {
            flex-direction: column;
        }
        
        .sidebar-filter {
            position: fixed;
            top: 0;
            right: -320px; /* Hidden by default */
            height: 100vh;
            z-index: 2000;
            transition: right 0.3s ease;
            width: 300px;
            overflow-y: auto;
        }

        .sidebar-filter.active {
            right: 0;
        }

        .d-md-none { display: block; }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #closeFilterBtn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        .sidebar-overlay.active { display: block; }
    }
</style>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<script>
    let allListings = [];
    
    document.addEventListener("DOMContentLoaded", async () => {
        // Show create button if logged in
        if (localStorage.getItem('token')) {
            const btn = document.getElementById('createBtn');
            if(btn) btn.style.display = 'inline-flex';
        }

        // Initialize Type Filter from ViewBag if available
        const initialType = '@ViewBag.InitialType';
        if (initialType) {
            const typeSelect = document.getElementById('filterType');
            if(typeSelect) {
                typeSelect.value = initialType;
                // Hide the filter container if type is pre-selected
                typeSelect.closest('.filter-group').style.display = 'none';
            }
            
            // Update Title based on type
            const title = document.querySelector('h1');
            if(title) {
                if(initialType === 'sale') title.innerText = "Cars for Sale";
                if(initialType === 'rent') title.innerText = "Cars for Rent";
            }
        }

        await fetchAllListings();
        populateBrands();
        
        // Initial render with filters applied if type is set
        if (initialType) {
            applyFilters();
        } else {
            renderListings(allListings);
        }

        // Filter Logic
        document.getElementById('applyFilters').addEventListener('click', () => {
             applyFilters();
             // Close sidebar on mobile after applying
             toggleSidebar(false);
        });

        // Mobile Sidebar Toggles
        document.getElementById('showFilterBtn').addEventListener('click', () => toggleSidebar(true));
        document.getElementById('closeFilterBtn').addEventListener('click', () => toggleSidebar(false));
        document.getElementById('sidebarOverlay').addEventListener('click', () => toggleSidebar(false));
    });

    function toggleSidebar(show) {
        const sidebar = document.querySelector('.sidebar-filter');
        const overlay = document.getElementById('sidebarOverlay');
        if (show) {
            sidebar.classList.add('active');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        } else {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    async function fetchAllListings() {
        try {
            const [saleRes, rentRes] = await Promise.all([
                fetch('/api/Listings/sale'),
                fetch('/api/Listings/rent')
            ]);
            
            const saleData = await saleRes.json();
            const rentData = await rentRes.json();

            const sales = (saleData.data || []).map(item => ({ ...item, type: 'sale' }));
            const rents = (rentData.data || []).map(item => ({ ...item, type: 'rent' }));

            allListings = [...sales, ...rents];
        } catch (err) {
            console.error("Error fetching listings:", err);
            document.getElementById('vehiclesGrid').innerHTML = '<p>Failed to load listings.</p>';
        }
    }

    function populateBrands() {
        const brands = [...new Set(allListings.map(item => item.brand || item.Brand))].filter(Boolean).sort();
        const brandSelect = document.getElementById('filterBrand');
        
        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand;
            option.innerText = brand;
            brandSelect.appendChild(option);
        });
    }

    function applyFilters() {
        const type = document.getElementById('filterType').value;
        const brand = document.getElementById('filterBrand').value;
        const engine = document.getElementById('filterEngine').value;
        const transmission = document.getElementById('filterTransmission').value;
        const search = document.getElementById('filterSearch').value.toLowerCase();
        
        const minYear = parseInt(document.getElementById('minYear').value) || 0;
        const maxYear = parseInt(document.getElementById('maxYear').value) || 9999;
        
        const minMileage = parseInt(document.getElementById('minMileage').value) || 0;
        const maxMileage = parseInt(document.getElementById('maxMileage').value) || 9999999;

        const filtered = allListings.filter(item => {
            const matchType = type === 'all' || item.type === type;
            const matchBrand = brand === 'all' || (item.brand || item.Brand) === brand;
            
            // Engine matching
            const itemEngine = (item.engineType !== undefined) ? item.engineType : (item.EngineType !== undefined ? item.EngineType : null);
             // Note: In a real app, we'd map the int enum to string, but assuming string match or 'all' for now.
             // If item.engineType is int, this filter might need adjustment based on API response.
             // For strict correctness, we'd need the enum mapping from the backend. 
             // Skipping strict engine check if "all" or simple match for MVP.
            const matchEngine = engine === 'all' || (itemEngine && itemEngine.toString() === engine) || true; // Placeholder: relying on API to return strings or handle int mapping if critical.

            // Transmission matching
            // Assuming TransmissionType is 0=Manual, 1=Automatic or similar, or returned as string.
            // We will check loose equality or string properties.
            const itemTrans = item.transmissionType !== undefined ? item.transmissionType : item.TransmissionType;
            // Map int to string if needed. Manual=0, Automatic=1 usually.
            // Let's assume the API returns the string name or we allow 'all' to pass.
            // If User selects "Automatic", we check if itemTrans is "Automatic" or 1.
            let transString = "";
            if (itemTrans === 1 || itemTrans === "Automatic") transString = "Automatic";
            if (itemTrans === 0 || itemTrans === "Manual") transString = "Manual";
            
            const matchTransmission = transmission === 'all' || transString === transmission;

            const matchYear = (item.year >= minYear && item.year <= maxYear);
            const matchMileage = (item.mileage >= minMileage && item.mileage <= maxMileage);

            // Search (Model, Description, Color)
            const matchSearch = !search || 
                                (item.model && item.model.toLowerCase().includes(search)) || 
                                (item.description && item.description.toLowerCase().includes(search)) ||
                                (item.color && item.color.toLowerCase().includes(search));

            return matchType && matchBrand && matchYear && matchMileage && matchTransmission && matchSearch;
        });

        renderListings(filtered);
    }
    
    // ... renderListings same as before ...


    function renderListings(items) {
        const container = document.getElementById('vehiclesGrid');
        const countSpan = document.getElementById('resultCount');
        
        container.innerHTML = '';
        countSpan.innerText = items.length;

        if (items.length === 0) {
            container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">No vehicles found matching your criteria.</div>';
            return;
        }

        items.forEach(item => {
            const isSale = item.type === 'sale';
            const priceLabel = isSale ? `$${item.price.toLocaleString()}` : `$${item.dailyRate}<span style="font-size:0.8rem; color:#666; font-weight:400;">/day</span>`;
            const badgeColor = isSale ? 'var(--primary-blue)' : 'var(--primary-green)';
            const badgeText = isSale ? 'For Sale' : 'For Rent';

            const card = document.createElement('div');
            card.className = 'listing-card';
            card.innerHTML = `
                <div class="card-img">
                    <span style="position: absolute; top: 12px; left: 12px; background: ${badgeColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; z-index: 10;">${badgeText}</span>
                    <img src="https://placehold.co/400x300?text=${encodeURIComponent(item.model)}" alt="${item.model}">
                </div>
                <div class="card-body">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size: 0.85rem; color: var(--text-muted); text-transform:uppercase; font-weight:600; letter-spacing:0.5px;">${item.brand}</div>
                            <div class="card-title" style="margin-top:2px;">${item.model}</div>
                        </div>
                    </div>
                    
                    <div class="card-price" style="margin-top: 12px;">${priceLabel}</div>
                    
                    <div style="display: flex; gap: 12px; margin-top: auto; padding-top: 16px; border-top: 1px solid #f0f0f0; color: var(--text-muted); font-size: 0.85rem;">
                         <span><span style="font-weight:600;">${item.year}</span></span>
                         <span>â€¢</span>
                         <span><span style="font-weight:600;">${item.mileage.toLocaleString()}</span> km</span>
                    </div>

                    <a href="/details/${item.id}?type=${item.type}" class="btn btn-outline" style="width: 100%; margin-top: 16px; border-width: 1px;">View Details</a>
                </div>
            `;
            container.appendChild(card);
        });
    }
</script>
