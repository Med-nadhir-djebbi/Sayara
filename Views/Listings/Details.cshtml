@{
    ViewData["Title"] = "Vehicle Experience";
}

<div class="details-wrapper animate-fade-in">
    <div class="container py-5">
        <!-- Breadcrumbs -->
        <nav class="breadcrumb-nav mb-4">
            <a href="/">Home</a> / <a href="/sale">Collection</a> / <span id="breadcrumbModel">Loading...</span>
        </nav>

        <div id="loading" class="text-center py-5">
            <div class="spinner-premium"></div>
            <p class="mt-3 text-muted">Retrieving Vehicle pedigree...</p>
        </div>
        
        <div id="detailsContent" style="display:none;">
            <div class="row g-5">
                <!-- Left: Immersive Gallery -->
                <div class="col-lg-7">
                    <div class="gallery-container">
                        <div class="main-stage">
                            <img id="mainImage" src="" alt="Vehicle Presentation" class="img-fluid rounded-premium shadow-premium">
                        </div>
                        <div class="thumbnail-strip mt-3" id="thumbStrip">
                            <!-- Thumbnails injected here -->
                        </div>
                    </div>
                    
                    <div class="description-box mt-5">
                        <h3 class="modern-heading">The Story</h3>
                        <p id="description" class="lead-text"></p>
                    </div>
                </div>
                
                <!-- Right: Precise Specs & Acquisition -->
                <div class="col-lg-5">
                    <div class="sticky-panel">
                        <div class="info-card premium-card">
                            <div class="card-header-luxury">
                                <h1 id="title" class="mb-1"></h1>
                                <div id="price" class="price-tag"></div>
                            </div>
                            
                            <div class="spec-grid mt-4">
                                <div class="spec-item">
                                    <span class="label">Year</span>
                                    <span class="value" id="year"></span>
                                </div>
                                <div class="spec-item">
                                    <span class="label">Mileage</span>
                                    <span class="value"><span id="mileage"></span> km</span>
                                </div>
                                <div class="spec-item">
                                    <span class="label">Engine</span>
                                    <span class="value" id="engine"></span>
                                </div>
                                <div class="spec-item">
                                    <span class="label">Color</span>
                                    <span class="value" id="color"></span>
                                </div>
                            </div>

                            <hr class="luxury-hr">

                            <div class="seller-brief">
                                <h5 class="mb-3">Consignment Details</h5>
                                <div class="d-flex align-items-center mb-3">
                                    <div class="avatar-mock"><i class="fas fa-user-tie"></i></div>
                                    <div class="ml-3">
                                        <div class="font-weight-bold" id="sellerName"></div>
                                        <div class="text-muted small">Verified Premium Seller</div>
                                    </div>
                                    <div class="ml-auto text-right">
                                        <div class="rating-badge">
                                            <i class="fas fa-star text-warning"></i> <span id="sellerRating">5.0</span>
                                        </div>
                                    </div>
                                </div>
                                <p class="small text-muted mb-4"><i class="fas fa-info-circle"></i> Security check completed on vehicle history.</p>
                                
                                <button class="btn btn-primary btn-block py-3 mb-2" onclick="alert('Digital concierge will contact you shortly.')">
                                    Inquire Now <i class="fas fa-paper-plane ml-2"></i>
                                </button>
                                <button id="editBtn" class="btn btn-warning btn-block py-3 mb-2" style="display:none;">
                                    <i class="fas fa-edit mr-2"></i> Edit Listing
                                </button>
                                <button id="deleteBtn" class="btn btn-danger btn-block py-3 mb-2" style="display:none;">
                                    <i class="fas fa-trash mr-2"></i> Delete Listing
                                </button>
                                <div class="text-center">
                                    <span class="text-muted small">Reference ID: <span id="listingId"></span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .rounded-premium { border-radius: 30px; }
    .shadow-premium { box-shadow: 0 30px 60px rgba(0,0,0,0.12); }
    .spinner-premium { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
    
    .breadcrumb-nav { font-size: 0.9rem; font-weight: 500; color: var(--text-muted); }
    .breadcrumb-nav a { color: var(--primary-blue); opacity: 0.8; }
    
    .price-tag { font-size: 2.5rem; font-weight: 900; color: var(--primary-green); letter-spacing: -1px; }
    .modern-heading { font-weight: 800; border-left: 5px solid var(--primary-blue); padding-left: 15px; margin-bottom: 25px; }
    .lead-text { font-size: 1.1rem; line-height: 1.8; color: var(--text-dark); opacity: 0.8; }
    
    .premium-card { background: white; border-radius: 32px; padding: 40px; border: 1px solid #f1f5f9; box-shadow: var(--shadow-premium); }
    .spec-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .spec-item { display: flex; flex-direction: column; }
    .spec-item .label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; }
    .spec-item .value { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); }
    
    .luxury-hr { border: 0; border-top: 1px solid #f1f5f9; margin: 30px 0; }
    .avatar-mock { width: 50px; height: 50px; background: #f8fafc; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--primary-blue); }
    .rating-badge { background: #fffbeb; color: #92400e; padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; }
    
    .sticky-panel { position: sticky; top: 120px; }
    .thumbnail-strip { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
    .thumb-item { width: 100px; height: 70px; object-fit: cover; border-radius: 12px; cursor: pointer; opacity: 0.6; transition: 0.3s; border: 2px solid transparent; }
    .thumb-item.active { opacity: 1; border-color: var(--primary-blue); }
    
    @@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const pathParts = window.location.pathname.split('/');
        const id = pathParts[pathParts.length - 1];
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type') || 'sale';

        try {
            const response = await fetch(`/api/Listings/${type}/${id}`);
            const result = await response.json();

            if (response.ok && result.data) {
                const item = result.data;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('detailsContent').style.display = 'block';
                
                document.getElementById('breadcrumbModel').innerText = item.model;
                document.getElementById('title').innerText = `${item.brandName || ''} ${item.model}`;
                document.getElementById('listingId').innerText = item.id;
                
                if (type === 'rent') {
                    document.getElementById('price').innerText = `$${item.dailyRate}/day`;
                } else {
                    document.getElementById('price').innerText = `$${(item.price || 0).toLocaleString()}`;
                }

                document.getElementById('year').innerText = item.year;
                document.getElementById('mileage').innerText = item.mileage.toLocaleString();
                document.getElementById('engine').innerText = item.engineType || 'Petrol/V8';
                document.getElementById('color').innerText = item.color;
                document.getElementById('description').innerText = item.description || 'No detailed history provided for this vehicle.';
                document.getElementById('sellerName').innerText = item.sellerName;
                
                if (item.sellerRating) document.getElementById('sellerRating').innerText = item.sellerRating.toFixed(1);

                // Check if current user is the owner
                const token = localStorage.getItem('token');
                console.log('Checking ownership - Token exists:', !!token, 'SellerUserId:', item.sellerUserId);
                if (token) {
                    try {
                        const decoded = JSON.parse(atob(token.split('.')[1]));
                        const currentUserId = parseInt(decoded.sub || decoded.nameid || decoded['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier']);
                        console.log('Current user ID:', currentUserId, 'Is owner:', currentUserId === item.sellerUserId);
                        
                        if (currentUserId === item.sellerUserId) {
                            document.getElementById('editBtn').style.display = 'block';
                            document.getElementById('deleteBtn').style.display = 'block';
                            
                            document.getElementById('editBtn').onclick = () => {
                                console.log('Edit clicked - navigating to /edit/' + item.id + '?type=' + type);
                                window.location.href = `/edit/${item.id}?type=${type}`;
                            };
                            
                            document.getElementById('deleteBtn').onclick = async () => {
                                if (!confirm('Are you sure you want to delete this listing? This action cannot be undone.')) return;
                                
                                try {
                                    const deleteResponse = await fetch(`/api/Listings/${id}`, {
                                        method: 'DELETE',
                                        headers: { 'Authorization': `Bearer ${token}` }
                                    });
                                    
                                    if (deleteResponse.ok) {
                                        alert('Listing deleted successfully');
                                        window.location.href = '/vehicles';
                                    } else {
                                        alert('Failed to delete listing');
                                    }
                                } catch (err) {
                                    console.error(err);
                                    alert('Error deleting listing');
                                }
                            };
                        }
                    } catch (e) {
                        console.log('Unable to decode token');
                    }
                }

                // Gallery Logic
                const images = item.imageUrls && item.imageUrls.length > 0 ? item.imageUrls : [`https://source.unsplash.com/1200x800/?luxury-car&sig=${item.id}`];
                const mainImg = document.getElementById('mainImage');
                const strip = document.getElementById('thumbStrip');
                
                mainImg.src = images[0];
                
                images.forEach((url, index) => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.className = `thumb-item ${index === 0 ? 'active' : ''}`;
                    img.onclick = () => {
                        mainImg.src = url;
                        document.querySelectorAll('.thumb-item').forEach(t => t.classList.remove('active'));
                        img.classList.add('active');
                    };
                    strip.appendChild(img);
                });
            } else {
                document.getElementById('loading').innerHTML = '<div class="alert alert-danger">Vehicle collection currently unavailable.</div>';
            }
        } catch (err) {
            console.error(err);
            document.getElementById('loading').innerText = "Pedigree synchronization failed.";
        }
    });
</script>
